<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Examen de Biolog√≠a</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f9fc; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .hidden { display: none; }
    .question { margin-bottom: 15px; }
    .options label { display: block; margin: 4px 0; }
    button { padding: 10px 16px; border: none; border-radius: 6px; background: #2563eb; color: #fff; cursor: pointer; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eee; margin-right:8px; }
  </style>
</head>
<body>
  <div class="card" id="startCard">
    <h2>Datos del postulante</h2>
    <label>Nombre completo</label>
    <input id="nombre" type="text" />
    <label>Celular</label>
    <input id="celular" type="text" />
    <label>Carrera</label>
    <input id="carrera" type="text" />
    <br><br>
    <button id="startBtn">Comenzar examen</button>
  </div>

  <div class="card hidden" id="examCard">
    <div>
      <span class="pill">Tiempo: <span id="timer">40:00</span></span>
      <span class="pill">Preguntas: <span id="count"></span>/40</span>
    </div>
    <div id="questions"></div>
    <button id="finishBtn">Finalizar</button>
  </div>

  <div class="card hidden" id="resultCard">
    <h2>Resultado</h2>
    <p>Puntaje: <span id="score"></span> / 100</p>
    <p>Estado: <span id="status"></span></p>
    <button id="downloadCsvBtn">Descargar CSV</button>
    <button onclick="location.reload()">Reiniciar</button>
  </div>

<script>
const TOTAL_QUESTIONS = 40;
const POINTS_PER_QUESTION = 2.5;
const DURATION_MINUTES = 40;
let QUESTION_BANK = [];
let selectedQuestions = [];
let answers = {};
let timerInterval, endTime;

// üîπ Cargar preguntas desde preguntas.csv
async function loadQuestions() {
  const response = await fetch("preguntas.csv");
  const text = await response.text();
  const rows = text.trim().split("\n");
  QUESTION_BANK = rows.map(row => {
    const [id, pregunta, A, B, C, D, correcta] = row.split(",");
    return { id:Number(id), pregunta, A, B, C, D, correcta };
  });
}
loadQuestions();

// üîπ Iniciar examen
document.getElementById("startBtn").addEventListener("click", () => {
  if (!QUESTION_BANK.length) { alert("Preguntas no cargadas a√∫n."); return; }
  const nombre = document.getElementById("nombre").value.trim();
  const celular = document.getElementById("celular").value.trim();
  const carrera = document.getElementById("carrera").value.trim();
  if (!nombre || !celular || !carrera) { alert("Completa todos los datos."); return; }

  // Seleccionar 40 preguntas aleatorias
  selectedQuestions = [...QUESTION_BANK].sort(() => Math.random()-0.5).slice(0,TOTAL_QUESTIONS);

  const container = document.getElementById("questions");
  container.innerHTML = "";
  selectedQuestions.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "question";
    div.innerHTML = `<strong>${idx+1}. ${q.pregunta}</strong>
      <div class="options">
        ${["A","B","C","D"].map(opt => `
          <label><input type="radio" name="q_${q.id}" value="${opt}"> ${opt}: ${q[opt]}</label>
        `).join("")}
      </div>`;
    container.appendChild(div);
  });

  document.getElementById("count").textContent = selectedQuestions.length;
  document.getElementById("startCard").classList.add("hidden");
  document.getElementById("examCard").classList.remove("hidden");

  // Temporizador
  endTime = Date.now() + DURATION_MINUTES*60*1000;
  timerInterval = setInterval(() => {
    const remaining = endTime - Date.now();
    if (remaining <= 0) { clearInterval(timerInterval); finish(); }
    const m = String(Math.floor(remaining/60000)).padStart(2,"0");
    const s = String(Math.floor((remaining%60000)/1000)).padStart(2,"0");
    document.getElementById("timer").textContent = `${m}:${s}`;
  }, 1000);

  container.addEventListener("change", e => {
    const id = Number(e.target.name.split("_")[1]);
    answers[id] = e.target.value;
  });
});

// üîπ Finalizar examen
document.getElementById("finishBtn").addEventListener("click", finish);
function finish() {
  clearInterval(timerInterval);
  let correct = 0;
  selectedQuestions.forEach(q => {
    if (answers[q.id] === q.correcta) correct++;
  });
  const score = (correct*POINTS_PER_QUESTION).toFixed(2);
  let status = "No aprobado";
  if (score > 81) status = "Admitido";
  else if (score > 51) status = "Aprobado";

  document.getElementById("score").textContent = score;
  document.getElementById("status").textContent = status;
  document.getElementById("examCard").classList.add("hidden");
  document.getElementById("resultCard").classList.remove("hidden");

  // CSV virtual
  const csv = `Nombre,Celular,Carrera,Puntaje,Estado\n${document.getElementById("nombre").value},${document.getElementById("celular").value},${document.getElementById("carrera").value},${score},${status}`;
  window.__lastCsv = csv;
}

// üîπ Descargar CSV
document.getElementById("downloadCsvBtn").addEventListener("click", () => {
  const blob = new Blob([window.__lastCsv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "resultado.csv";
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
